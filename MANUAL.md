# Инструкция: Основы Nginx и анализ конфигурации с динамическими зонами защиты

---

## 1. Введение

Эта инструкция объясняет основы Nginx и плавно подводит к разбору сложной конфигурации, которая использует **динамическое разделение лимитов по зонам**. Такой подход позволяет создавать разные уровни защиты для разных групп IP-адресов и предотвращает флуд, DDoS, массовые запросы, ботов и агрессивных клиентов.

---

## 2. Основы Nginx, которые нужно знать

### 2.1. `limit_req_zone` и `limit_conn_zone`

Определяет зоны для дальнейшего использования их в `limit_req` и `limit_conn`, важно понимать, что лимиты тут вы не устанавливаете для конкретных айпи, а так сказать делаете настройку, которую дальше будете применять к конкретным случаям, дальше это будет описано подробнее

### 2.2. `limit_req`

Ограничение количества запросов для одного клиента. Используется для защиты от спама и DDoS среднего уровня.
Тут вы как раз и применяете настройку из выше полученных зон, в нужных вам местах

### 2.3. `limit_conn`

Ограничивает количество одновременных соединений.
Тут вы как раз и применяете настройку из выше полученных зон, в нужных вам местах

### 2.4. `map`

Дает возможность создавать логические переменные, например для фильтрации ботов.

### 2.5. `geo`

Позволяет разделять клиентов по IP-адресам или диапазонам.

### 2.6. Внутренние локации

Используются для многоуровневой маршрутизации трафика без прямой видимости пользователю.

---

## ВАЖНО: `limit_req` и `limit_conn` нельзя использовать в логических блоках ( if ), `error` страницах и переменные в объявлении

---

## 3. Что делает эта конфигурация

Приведённая конфигурация создаёт **две зоны трафика**:

* доверенная зона (назовём её `school`)
* обычные пользователи (`other`)

Для каждой зоны задаются индивидуальные:

* лимиты на запросы (медленные и быстрые)
* лимиты соединений
* скорости скачивания
* отдельные access-логи

Также фильтруются распространённые User-Agent ботов.
Хоть их и можно легко поменять, но до этого надо додуматься + если не знать как это работает, тоже уйдет время на то чтобы понять, что можно просто поставить вручную этот заголовок 

---

## 4. Разбор конфигурации

### 4.1. Определение лимитов

```nginx
limit_req_zone $binary_remote_addr zone=ip_school_min:64m rate=Xr/m;
limit_req_zone $binary_remote_addr zone=ip_other_min:64m rate=Xr/m;

limit_req_zone $binary_remote_addr zone=ip_school:64m rate=Xr/s;
limit_req_zone $binary_remote_addr zone=ip_other:64m rate=Xr/s;

limit_conn_zone $binary_remote_addr zone=ip_school_conn:32m;
limit_conn_zone $binary_remote_addr zone=ip_other_conn:32m;
```

`$binary_remote_addr` - как сохранять блокировки (ключ) - айпишник
`zone=ip_other` - название зоны
`64m` - сколько памяти выделять на сохранение блокировок
`rate=Xr/s` - сколько разрешаем делать запросов за указанное время

**Смысл**: доверенной сети можно гораздо больше, обычным пользователям меньше.

---

### 4.2. Фильтрация ботов

```nginx
map $http_user_agent $bad_bot {
    default 0;
    "~*curl" 1;
    "~*python" 1;
    "~*wget" 1;
    "~*bot" 1;
    "~*spider" 1;
    "~*scrapy" 1;
    "~*postman" 1;
    "~*insomnia" 1;
    "~*httpie" 1;
    "~*okhttp" 1;
    "~*java" 1;
    "~*node-fetch" 1;
}
```

**Смысл**: автоматизированные клиенты блокируются сразу, хоть это можно поменять, задает хоть какие-то трудности

---

### 4.3. Разделение клиентов по IP

```nginx
geo $zone_type {
    10.10.10.0/24  school;
    10.10.20.0/24  school;
    default         other;
}
```

Укажите реальные IP, если это требуется.

---

### 4.4. Главная логика маршрутизации

#### Основной location

```nginx
location / {
    if ($bad_bot) { return 403; }

    if ($zone_type = other) {
        rewrite ^ /__zone__other$request_uri last;
    }

    rewrite ^ $request_uri break;

    limit_conn ip_school_conn 500;
    limit_req zone=ip_school burst=100;
    limit_req zone=ip_school_min burst=2000;

    limit_rate_after 5m;
    limit_rate 250k;

    proxy_pass https://backend/;
    access_log /var/log/nginx/access-school.log combined;
}
```

**Смысл**:

* «хорошие» сети идут сюда
* у них огромные лимиты
* им доверяют и дают высокий предел нагрузки

**Важные коментарии**:
* `rewrite ^ $request_uri break;` - помогает решить баг возникающий при использовании русских символов в URL
* `access_log /var/log/nginx/access-school.log combined;` - Сохраняем весь трафик этой локации в нужный файл, в стандартном виде
* `proxy_pass https://backend/;` - получаем ответ от бекенда и возвращаем ответ пользователю под текущим доменом
* `limit_rate_after 5m;
    limit_rate 250k;` - Даем пользователю сначала прогрузить основную часть файла (в случаи какого-либо скачивания), потом отдаем небольшими кусочками, помогает снизить нагрузку, при большой загрузке
* `if ($zone_type = other) {
        rewrite ^ /__zone__other$request_uri last;
    }` - незаметно для пользователя изменяем урл и просим nginx заново найти нужную локацию, в которой уже заданы нужные лимиты


#### Локация для остальных

```nginx
location /__zone__other {
    if ($zone_type != other) { return 404; }

    rewrite ^ $request_uri break;

    limit_conn ip_other_conn 15;
    limit_req zone=ip_other burst=10;
    limit_req zone=ip_other_min burst=600;

    limit_rate_after 5m;
    limit_rate 250k;

    proxy_pass https://backend/;
    access_log /var/log/nginx/access-other.log combined;
}
```

**Смысл**:

* обычные пользователи жёстко ограничены
* трафик идёт через отдельный блок
* всё записывается в другой лог
* можно создать еще локаций для разделений
* лимиты все равно будут работать, не будут урезаться
* пользователь будет попадать на изначальный эндпоинт

`rewrite ^ $request_uri break;` - незаметно для пользователя изменяем урл на изначальный и просим nginx не искать новую локацию, а продолжать логику в текущей под новым URL

---

## 5. Что можно изучить дальше

* создание зон повышенного доверия
* динамическое управление лимитами через GeoIP
* авторегистрация IP-листов
* защита API
* взаимодействие с fail2ban

---

## 6. Заключение

Эта конфигурация показывает, как можно значительно расширить возможности Nginx и превратить его в многоуровневый фильтр трафика. При грамотном использовании он способен обеспечивать действительно высокий уровень безопасности без воздействия на производительность.
